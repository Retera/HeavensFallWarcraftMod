//===========================================================================
// 
// fl01
// 
//   Warcraft III AI script
//   Generated by the Warcraft III World Editor
//   Date: Sat Jun 19 13:29:45 2010
// 
//===========================================================================

//***************************************************************************
//*
//*  Global Variables
//*
//***************************************************************************

globals
    integer                 attackWave                 = 1
    integer                 nextDelay                  = 0
    integer                 awGold                     = 0
    integer                 awWood                     = 0

    // Conditions
    boolean                 gCond_Extra_Money          = false
    boolean                 gCond_Gold_Mine_Creeps_Dont_Needa_Killin = false
    boolean                 gCond_Exp_1                = false
    boolean                 gCond_Exp_2                = false
    boolean                 gCond_Blue_Moon_Risen      = false
    boolean                 gCond_No_Cubs              = false
    boolean                 gCond_TwoLCubs             = false
    boolean                 gCond_FourLCubs            = false
    boolean                 gCond_SixLCubs             = false
    boolean                 gCond_EightLCubs           = false
    boolean                 gCond_Level_1              = false
    boolean                 gCond_Level_2              = false
    boolean                 bringWar                   = false
endglobals

//***************************************************************************
//*
//*  Utility Functions
//*
//***************************************************************************

//===========================================================================
function CheckLastCommand takes boolean pop returns integer
    local integer cmd = GetLastCommand()
    if (pop) then
        call PopLastCommand(  )
    endif
    return cmd
endfunction

//===========================================================================
function CheckLastCommandData takes boolean pop returns integer
    local integer data = GetLastData()
    if (pop) then
        call PopLastCommand(  )
    endif
    return data
endfunction

//===========================================================================
function TotalFoodProduced takes nothing returns integer
    return GetPlayerState(ai_player,PLAYER_STATE_RESOURCE_FOOD_CAP)
endfunction

//===========================================================================
function ExpansionNeeded takes nothing returns boolean
    return take_exp
endfunction

//===========================================================================
function BuildExpansion takes integer hallID, integer mineID returns nothing
    if (HallsCompleted(hallID)) then
        call SetBuildExpa( TownCount(hallID) + 1, mineID )
    endif
endfunction

//===========================================================================
function CurrentAttackWave takes nothing returns integer
    return attackWave
endfunction

//===========================================================================
function ResetAttackUnits takes nothing returns nothing
    set awGold = 0
    set awWood = 0
    call InitAssaultGroup(  )
endfunction

//===========================================================================
function AddAttackUnit takes integer minQty, integer maxQty, integer unitID returns nothing
    // Track attacking gold workers
    if (unitID == 'e014') then
        set awGold = awGold + minQty
    endif

    // Track attacking wood workers
    if (unitID == 'e014') then
        set awWood = awWood + minQty
    endif

    call SetAssaultGroup( minQty, maxQty, unitID )
endfunction

//***************************************************************************
//*
//*  Basic Options
//*
//***************************************************************************

//===========================================================================
function InitOptions takes nothing returns nothing
    call SetMeleeAI(  )
    call SetDefendPlayer( true )
    call SetRandomPaths( false )
    call SetTargetHeroes( true )
    call SetPeonsRepair( true )
    call SetHeroesFlee( true )
    call SetHeroesBuyItems( true )
    call SetUnitsFlee( true )
    call SetGroupsFlee( true )
    call SetWatchMegaTargets( true )
    call SetIgnoreInjured( true )
    call SetHeroesTakeItems( true )
    call SetSlowChopping( false )
    call SetCaptainChanges( true )
    call SetSmartArtillery( true )
endfunction

//***************************************************************************
//*
//*  Conditions
//*
//***************************************************************************

//===========================================================================
// Updates the values of all preset conditions
//===========================================================================
function UpdateConditions takes nothing returns nothing
    set gCond_Extra_Money = ( GetGold(  ) > 250 )
    set gCond_Gold_Mine_Creeps_Dont_Needa_Killin = ( ExpansionNeeded(  ) == false )
    set gCond_Exp_1 = ( TownHasMine( 2 ) == true )
    set gCond_Exp_2 = ( TownHasMine( 3 ) == true )
    set gCond_Blue_Moon_Risen = ( GetUpgradeLevel( 'R01G' ) == 1 )
    set gCond_No_Cubs = ( GetUnitCount( 'o016' ) == 0 )
    set gCond_TwoLCubs = ( GetUnitCount( 'o016' ) <= 2 )
    set gCond_FourLCubs = ( GetUnitCount( 'o016' ) <= 4 )
    set gCond_SixLCubs = ( GetUnitCount( 'o016' ) <= 6 )
    set gCond_EightLCubs = ( GetUnitCount( 'o016' ) <= 8 )
    set gCond_Level_1 = ( ( GetUnitCount( 'h01E' ) == 0 ) and ( GetUnitCount( 'h01F' ) == 0 ) )
    set gCond_Level_2 = ( GetUnitCount( 'h01F' ) == 0 )
    if( GetLastCommand() == 5 ) then
    set bringWar = true
    endif
endfunction

//***************************************************************************
//*
//*  Heroes
//*
//***************************************************************************

//===========================================================================
// Stores hero ID and skills
//===========================================================================
function SetHero takes integer order, integer heroid returns nothing
    if (order == 1) then
        set hero_id = heroid
        if (heroid == 'U017') then
            set skills1[ 1] = 'A085'
            set skills1[ 2] = 'A087'
            set skills1[ 3] = 'A08D'
            set skills1[ 4] = 'A085'
            set skills1[ 5] = 'A087'
            set skills1[ 6] = 'A08A'
            set skills1[ 7] = 'A08D'
            set skills1[ 8] = 'A085'
            set skills1[ 9] = 'A087'
            set skills1[10] = 'A08D'
        elseif (heroid == 'E016') then
            set skills1[ 1] = 'A08K'
            set skills1[ 2] = 'A08L'
            set skills1[ 3] = 'A08T'
            set skills1[ 4] = 'A08K'
            set skills1[ 5] = 'A08L'
            set skills1[ 6] = 'A09Z'
            set skills1[ 7] = 'A08T'
            set skills1[ 8] = 'A08K'
            set skills1[ 9] = 'A08L'
            set skills1[10] = 'A08T'
        elseif (heroid == 'N01O') then
            set skills1[ 1] = 'A096'
            set skills1[ 2] = 'A098'
            set skills1[ 3] = 'A097'
            set skills1[ 4] = 'A096'
            set skills1[ 5] = 'A098'
            set skills1[ 6] = 'A099'
            set skills1[ 7] = 'A097'
            set skills1[ 8] = 'A096'
            set skills1[ 9] = 'A098'
            set skills1[10] = 'A097'
        endif
    elseif (order == 2) then
        set hero_id2 = heroid
        if (heroid == 'U017') then
            set skills2[ 1] = 'A085'
            set skills2[ 2] = 'A087'
            set skills2[ 3] = 'A08D'
            set skills2[ 4] = 'A085'
            set skills2[ 5] = 'A087'
            set skills2[ 6] = 'A08A'
            set skills2[ 7] = 'A08D'
            set skills2[ 8] = 'A085'
            set skills2[ 9] = 'A087'
            set skills2[10] = 'A08D'
        elseif (heroid == 'E016') then
            set skills2[ 1] = 'A08K'
            set skills2[ 2] = 'A08L'
            set skills2[ 3] = 'A08T'
            set skills2[ 4] = 'A08K'
            set skills2[ 5] = 'A08L'
            set skills2[ 6] = 'A09Z'
            set skills2[ 7] = 'A08T'
            set skills2[ 8] = 'A08K'
            set skills2[ 9] = 'A08L'
            set skills2[10] = 'A08T'
        elseif (heroid == 'N01O') then
            set skills2[ 1] = 'A096'
            set skills2[ 2] = 'A098'
            set skills2[ 3] = 'A097'
            set skills2[ 4] = 'A096'
            set skills2[ 5] = 'A098'
            set skills2[ 6] = 'A099'
            set skills2[ 7] = 'A097'
            set skills2[ 8] = 'A096'
            set skills2[ 9] = 'A098'
            set skills2[10] = 'A097'
        endif
    elseif (order == 3) then
        set hero_id3 = heroid
        if (heroid == 'U017') then
            set skills3[ 1] = 'A085'
            set skills3[ 2] = 'A087'
            set skills3[ 3] = 'A08D'
            set skills3[ 4] = 'A085'
            set skills3[ 5] = 'A087'
            set skills3[ 6] = 'A08A'
            set skills3[ 7] = 'A08D'
            set skills3[ 8] = 'A085'
            set skills3[ 9] = 'A087'
            set skills3[10] = 'A08D'
        elseif (heroid == 'E016') then
            set skills3[ 1] = 'A08K'
            set skills3[ 2] = 'A08L'
            set skills3[ 3] = 'A08T'
            set skills3[ 4] = 'A08K'
            set skills3[ 5] = 'A08L'
            set skills3[ 6] = 'A09Z'
            set skills3[ 7] = 'A08T'
            set skills3[ 8] = 'A08K'
            set skills3[ 9] = 'A08L'
            set skills3[10] = 'A08T'
        elseif (heroid == 'N01O') then
            set skills3[ 1] = 'A096'
            set skills3[ 2] = 'A098'
            set skills3[ 3] = 'A097'
            set skills3[ 4] = 'A096'
            set skills3[ 5] = 'A098'
            set skills3[ 6] = 'A099'
            set skills3[ 7] = 'A097'
            set skills3[ 8] = 'A096'
            set skills3[ 9] = 'A098'
            set skills3[10] = 'A097'
        endif
    endif
endfunction

//===========================================================================
// Selects hero IDs for three possible heroes
//===========================================================================
function SelectHeroes takes nothing returns nothing
    local integer roll = GetRandomInt(1,100)
    if (roll <= 24) then
        call SetHero( 1, 'U017' )
        call SetHero( 2, 'E016' )
        call SetHero( 3, 'N01O' )
    elseif (roll <= 50) then
        call SetHero( 1, 'U017' )
        call SetHero( 2, 'N01O' )
        call SetHero( 3, 'E016' )
    elseif (roll <= 74) then
        call SetHero( 1, 'E016' )
        call SetHero( 2, 'U017' )
        call SetHero( 3, 'N01O' )
    else
        call SetHero( 1, 'E016' )
        call SetHero( 2, 'N01O' )
        call SetHero( 3, 'U017' )
    endif
endfunction

//===========================================================================
// Returns the hero skill for the given hero and level
//===========================================================================
function ChooseHeroSkill takes nothing returns integer
    local integer curHero = GetHeroId()
    local integer level = GetHeroLevelAI()

    if (level > max_hero_level) then
        set max_hero_level = level
    endif

    if (curHero == hero_id) then
        return skills1[level]
    elseif (curHero == hero_id2) then
        return skills2[level]
    elseif (curHero == hero_id3) then
        return skills3[level]
    endif
    return 0
endfunction

//***************************************************************************
//*
//*  Building and Harvesting
//*
//***************************************************************************

//===========================================================================
// Specifies building priorities for workers
//===========================================================================
function BuildPriorities takes nothing returns nothing
    local integer mine = TownWithMine()
    if (gCond_Level_1) then
        call SetBuildAll( BUILD_UNIT, 1, 'h01C', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 1, 'e014', -1 )
    call SetBuildAll( BUILD_UNIT, 2, 'e014', -1 )
    call SetBuildAll( BUILD_UNIT, 3, 'e014', -1 )
    call SetBuildAll( BUILD_UNIT, 4, 'e014', -1 )
    call SetBuildAll( BUILD_UNIT, 5, 'e014', -1 )
    call SetBuildAll( BUILD_UNIT, 6, 'e014', -1 )
    call SetBuildAll( BUILD_UNIT, 1, 'h01G', -1 )
    call SetBuildAll( BUILD_UNIT, 7, 'e014', -1 )
    call SetBuildAll( BUILD_UNIT, 8, 'e014', -1 )
    call SetBuildAll( BUILD_UNIT, 1, 'e015', -1 )
    call SetBuildAll( BUILD_UNIT, 9, 'e014', -1 )
    call SetBuildAll( BUILD_UNIT, 10, 'e014', -1 )
    call SetBuildAll( BUILD_UNIT, 1, 'h022', -1 )
    call SetBuildAll( BUILD_UNIT, 11, 'e014', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 1, hero_id, -1 )
    call SetBuildAll( BUILD_UNIT, 1, 'o017', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 2, 'h022', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 2, 'o017', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 1, 'u016', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 1, 'o01A', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 3, 'h022', -1 )
    call SetBuildAll( BUILD_UNIT, 12, 'e014', -1 )
    call SetBuildAll( BUILD_UNIT, 1, 'n01P', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 2, 'o01A', -1 )
    endif
    if (gCond_Level_2) then
        call SetBuildAll( BUILD_UNIT, 1, 'h01E', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 4, 'h022', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 3, 'o017', -1 )
    endif
    call SetBuildAll( BUILD_UPGRADE, 1, 'R012', -1 )
    call SetBuildAll( BUILD_UNIT, 1, 'o01B', -1 )
    call SetBuildAll( BUILD_UPGRADE, 1, 'R01K', -1 )
    if (gCond_Extra_Money) then
        call SetBuildAll( BUILD_UNIT, 1, 'h01U', -1 )
        call SetBuildAll( BUILD_UNIT, 2, 'h01U', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 1, 'h01Z', -1 )
    if( bringWar ) then
    if (gCond_No_Cubs) then
        call SetBuildAll( BUILD_UNIT, 1, 'o018', -1 )
    endif
    endif
    call SetBuildAll( BUILD_UPGRADE, 1, 'R015', -1 )
    call SetBuildAll( BUILD_UNIT, 5, 'h022', -1 )
    call SetBuildAll( BUILD_UPGRADE, 1, 'R01A', -1 )
    call SetBuildAll( BUILD_UPGRADE, 1, 'R01I', -1 )
    if (gCond_Extra_Money) then
        call SetBuildAll( BUILD_UNIT, 1, 'h01W', -1 )
        call SetBuildAll( BUILD_UNIT, 2, 'h01W', -1 )
    endif
    call BuildExpansion( 'h01C', 'h01C' )
    if (gCond_Exp_1) then
        call SetBuildAll( BUILD_UNIT, 13, 'e014', -1 )
    endif
    if( bringWar ) then
    if (gCond_TwoLCubs) then
        call SetBuildAll( BUILD_UNIT, 2, 'o018', -1 )
    endif
    endif
    call SetBuildAll( BUILD_UPGRADE, 1, 'R01H', -1 )
    if( bringWar ) then
    if (gCond_FourLCubs) then
        call SetBuildAll( BUILD_UNIT, 3, 'o018', -1 )
    endif
    endif
    call SetBuildAll( BUILD_UNIT, 6, 'h022', -1 )
    if (gCond_Exp_1) then
        call SetBuildAll( BUILD_UNIT, 14, 'e014', -1 )
    endif
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 1, hero_id2, -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 7, 'h022', -1 )
    call SetBuildAll( BUILD_UNIT, 15, 'e014', -1 )
    call SetBuildAll( BUILD_UPGRADE, 2, 'R01H', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 1, 'o019', -1 )
    call SetBuildAll( BUILD_UNIT, 4, 'o017', -1 )
    endif
    if (gCond_Exp_1) then
        call SetBuildAll( BUILD_UNIT, 16, 'e014', -1 )
    endif
    call SetBuildAll( BUILD_UPGRADE, 2, 'R012', -1 )
    call SetBuildAll( BUILD_UNIT, 8, 'h022', -1 )
    call SetBuildAll( BUILD_UNIT, 17, 'e014', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 2, 'o019', -1 )
    call SetBuildAll( BUILD_UNIT, 3, 'o01A', -1 )
    call SetBuildAll( BUILD_UNIT, 1, 'h023', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 9, 'h022', -1 )
    call SetBuildAll( BUILD_UNIT, 1, 'h01F', -1 )
    call SetBuildAll( BUILD_UPGRADE, 2, 'R01K', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 2, 'h023', -1 )
    if (gCond_SixLCubs) then
        call SetBuildAll( BUILD_UNIT, 4, 'o018', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 4, 'o01A', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 10, 'h022', -1 )
    call SetBuildAll( BUILD_UPGRADE, 2, 'R01A', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 3, 'h023', -1 )
    endif
    call SetBuildAll( BUILD_UPGRADE, 1, 'R01B', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 1, 'n01E', -1 )
    endif
    if (gCond_Exp_1) then
        call SetBuildAll( BUILD_UNIT, 1, 'e014', 1 )
    endif
    call SetBuildAll( BUILD_UNIT, 11, 'h022', -1 )
    call SetBuildAll( BUILD_UPGRADE, 2, 'R01I', -1 )
    call SetBuildAll( BUILD_UPGRADE, 1, 'R01J', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 1, 'h01I', -1 )
    endif
    call SetBuildAll( BUILD_UPGRADE, 1, 'R01E', -1 )
    if (gCond_Exp_1) then
        call SetBuildAll( BUILD_UNIT, 2, 'e014', 1 )
    endif
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 1, hero_id3, -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 12, 'h022', -1 )
    call SetBuildAll( BUILD_UPGRADE, 3, 'R012', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 1, 'n01Q', -1 )
    call SetBuildAll( BUILD_UNIT, 2, 'h01I', -1 )
    call SetBuildAll( BUILD_UNIT, 5, 'o017', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 1, 'h021', -1 )
    call SetBuildAll( BUILD_UNIT, 13, 'h022', -1 )
    call SetBuildAll( BUILD_UNIT, 14, 'h022', -1 )
    call SetBuildAll( BUILD_UPGRADE, 1, 'R01R', -1 )
    call SetBuildAll( BUILD_UPGRADE, 3, 'R01K', -1 )
    call SetBuildAll( BUILD_UPGRADE, 2, 'R01J', -1 )
    call SetBuildAll( BUILD_UPGRADE, 1, 'R01M', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 2, 'n01E', -1 )
    call SetBuildAll( BUILD_UNIT, 1, 'n01N', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 15, 'h022', -1 )
    call SetBuildAll( BUILD_UNIT, 16, 'h022', -1 )
    call SetBuildAll( BUILD_UPGRADE, 3, 'R01A', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 2, 'n01Q', -1 )
    call SetBuildAll( BUILD_UNIT, 3, 'h01I', -1 )
    call SetBuildAll( BUILD_UNIT, 3, 'n01E', -1 )
    call SetBuildAll( BUILD_UNIT, 2, 'n01N', -1 )
    endif
    if (gCond_Extra_Money) then
        call SetBuildAll( BUILD_UNIT, 3, 'h01U', -1 )
        call SetBuildAll( BUILD_UNIT, 4, 'h01U', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 17, 'h022', -1 )
    call SetBuildAll( BUILD_UPGRADE, 3, 'R01I', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 4, 'h023', -1 )
    call SetBuildAll( BUILD_UNIT, 4, 'h01I', -1 )
    endif
    call SetBuildAll( BUILD_UPGRADE, 1, 'R016', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 3, 'n01N', -1 )
    endif
    call BuildExpansion( 'h01C', 'h01C' )
    call SetBuildAll( BUILD_UNIT, 18, 'h022', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 3, 'n01Q', -1 )
    endif
    call SetBuildAll( BUILD_UPGRADE, 1, 'R01N', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 5, 'o01A', -1 )
    endif
    if (gCond_Exp_2) then
        call SetBuildAll( BUILD_UNIT, 1, 'e014', 2 )
    endif
    call SetBuildAll( BUILD_UNIT, 19, 'h022', -1 )
    call SetBuildAll( BUILD_UPGRADE, 1, 'R01F', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 1, 'n01F', -1 )
    call SetBuildAll( BUILD_UNIT, 6, 'o01A', -1 )
    endif
    if( bringWar ) then
    if (gCond_Exp_2) then
        call SetBuildAll( BUILD_UNIT, 2, 'e014', 2 )
    endif
    endif
    call SetBuildAll( BUILD_UNIT, 20, 'h022', -1 )
    call SetBuildAll( BUILD_UPGRADE, 2, 'R01F', -1 )
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 5, 'h01I', -1 )
    call SetBuildAll( BUILD_UNIT, 4, 'n01E', -1 )
    endif
    if (gCond_Exp_2) then
        call SetBuildAll( BUILD_UNIT, 3, 'e014', 2 )
    endif
    call SetBuildAll( BUILD_UNIT, 21, 'h022', -1 )
    call SetBuildAll( BUILD_UNIT, 22, 'h022', -1 )
    if (gCond_Blue_Moon_Risen) then
        call SetBuildAll( BUILD_UPGRADE, 1, 'R01L', -1 )
    endif
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 1, 'h020', -1 )
    endif
    if (gCond_Blue_Moon_Risen) then
        call SetBuildAll( BUILD_UPGRADE, 1, 'R01O', -1 )
        call SetBuildAll( BUILD_UPGRADE, 1, 'R01Q', -1 )
    endif
    if (gCond_Exp_2) then
        call SetBuildAll( BUILD_UNIT, 4, 'e014', 2 )
    endif
    call SetBuildAll( BUILD_UNIT, 23, 'h022', -1 )
    call SetBuildAll( BUILD_UNIT, 24, 'h022', -1 )
    if (gCond_Blue_Moon_Risen) then
        call SetBuildAll( BUILD_UPGRADE, 1, 'R02P', -1 )
    endif
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 2, 'h020', -1 )
    endif
    if( bringWar ) then
    if (gCond_EightLCubs) then
        call SetBuildAll( BUILD_UNIT, 5, 'o018', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 5, 'n01E', -1 )
    endif
    if (gCond_Exp_2) then
        call SetBuildAll( BUILD_UNIT, 5, 'e014', 2 )
    endif
    call BuildExpansion( 'h01C', 'h01C' )
    call SetBuildAll( BUILD_UNIT, 25, 'h022', -1 )
    call SetBuildAll( BUILD_UNIT, 26, 'h022', -1 )
    if( bringWar ) then
    if (gCond_Blue_Moon_Risen) then
        call SetBuildAll( BUILD_UNIT, 1, 'n01R', -1 )
    endif
    endif
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 3, 'h020', -1 )
    call SetBuildAll( BUILD_UNIT, 6, 'h01I', -1 )
    call SetBuildAll( BUILD_UNIT, 6, 'o017', -1 )
    endif
    if (gCond_Blue_Moon_Risen) then
        call SetBuildAll( BUILD_UNIT, 2, 'h021', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 27, 'h022', -1 )
    if (gCond_Blue_Moon_Risen) then
    if( bringWar ) then
        call SetBuildAll( BUILD_UNIT, 2, 'n01R', -1 )
    endif
    endif
    if( bringWar ) then
    call SetBuildAll( BUILD_UNIT, 4, 'h020', -1 )
    call SetBuildAll( BUILD_UNIT, 7, 'h01I', -1 )
    call SetBuildAll( BUILD_UNIT, 7, 'o017', -1 )
    if (gCond_Blue_Moon_Risen) then
        call SetBuildAll( BUILD_UNIT, 3, 'n01R', -1 )
    endif
    endif
    call SetBuildAll( BUILD_UNIT, 28, 'h022', -1 )
    if( bringWar ) then
    if (gCond_Blue_Moon_Risen) then
        call SetBuildAll( BUILD_UNIT, 4, 'n01R', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 4, 'n01Q', -1 )
    call SetBuildAll( BUILD_UNIT, 8, 'h01I', -1 )
    call SetBuildAll( BUILD_UNIT, 7, 'o01A', -1 )
    if (gCond_Blue_Moon_Risen) then
        call SetBuildAll( BUILD_UNIT, 5, 'n01R', -1 )
    endif
    endif
    call SetBuildAll( BUILD_UNIT, 29, 'h022', -1 )
    if( bringWar ) then
    if (gCond_Blue_Moon_Risen) then
        call SetBuildAll( BUILD_UNIT, 6, 'n01R', -1 )
    endif
    call SetBuildAll( BUILD_UNIT, 9, 'h01I', -1 )
    if (gCond_Blue_Moon_Risen) then
        call SetBuildAll( BUILD_UNIT, 7, 'n01R', -1 )
    endif
    endif
    call SetBuildAll( BUILD_UNIT, 5, 'h01U', -1 )
    call SetBuildAll( BUILD_UNIT, 6, 'h01U', -1 )
    call SetBuildAll( BUILD_UNIT, 1, 'h01V', -1 )
    call SetBuildAll( BUILD_UNIT, 2, 'h01V', -1 )
    call SetBuildAll( BUILD_UNIT, 3, 'h01V', -1 )
    call SetBuildAll( BUILD_UNIT, 4, 'h01V', -1 )
    call SetBuildAll( BUILD_UPGRADE, 1, 'R013', -1 )
    call SetBuildAll( BUILD_UPGRADE, 1, 'R019', -1 )
    call SetBuildAll( BUILD_UPGRADE, 1, 'R018', -1 )
    call SetBuildAll( BUILD_UPGRADE, 1, 'R017', -1 )
endfunction

//===========================================================================
// Specifies harvesting priorities for workers
//===========================================================================
function HarvestPriorities takes nothing returns nothing
    local integer mine = TownWithMine()
    local integer allGold = GetUnitCountDone('e014')
    local integer allWood = GetUnitCountDone('e014')
    local integer numWorkers
    set numWorkers = 5
    call HarvestGold( 0, numWorkers )
    set numWorkers = 5
    call HarvestWood( 0, numWorkers )
    if (( TownHasMine( 2 ) == true )) then
        set numWorkers = 5
        call HarvestGold( 1, numWorkers )
    endif
    set numWorkers = 4
    call HarvestWood( 0, numWorkers )
    if (( TownHasMine( 3 ) == true )) then
        set numWorkers = 5
        call HarvestGold( 2, numWorkers )
    endif
    if (( TownHasMine( 4 ) == true )) then
        set numWorkers = 5
        call HarvestGold( 3, numWorkers )
    endif
endfunction

//===========================================================================
// Determines all building and harvesting assignments for workers
//===========================================================================
function WorkerAssignment takes nothing returns nothing
    loop
        call UpdateConditions(  )

        // Harvesting
        call ClearHarvestAI(  )
        call HarvestPriorities(  )

        // Building
        call InitBuildArray(  )
        call BuildPriorities(  )

        call Sleep( 2 )
    endloop
endfunction

//***************************************************************************
//*
//*  Attacking
//*
//***************************************************************************

//===========================================================================
// Returns true if the minimum forces for an attack exist
//===========================================================================
function HaveMinimumAttackers takes nothing returns boolean
    local integer count

    // Check for attack wave limit
    if (attackWave > 1) then
        return false
    endif

    // First Hero Only
    if (GetUnitCountDone(hero_id) < 1) then
        return false
    endif

    return true
endfunction

//===========================================================================
// Assigns units to attack based on the given attack group
//===========================================================================
function PrepareAttackGroup takes integer groupID returns nothing
    local integer all

    // Attack Group #1: All Units
    if (groupID == 1) then
        set all = GetUnitCountDone( hero_id )
        call AddAttackUnit( all, all, hero_id )
        set all = GetUnitCountDone( hero_id2 )
        call AddAttackUnit( all, all, hero_id2 )
        set all = GetUnitCountDone( hero_id3 )
        call AddAttackUnit( all, all, hero_id3 )
        set all = GetUnitCountDone( 'o01A' )
        call AddAttackUnit( all, all, 'o01A' )
        set all = GetUnitCountDone( 'n01E' )
        call AddAttackUnit( all, all, 'n01E' )
        set all = GetUnitCountDone( 'o017' )
        call AddAttackUnit( all, all, 'o017' )
        set all = GetUnitCountDone( 'o018' )
        call AddAttackUnit( all, all, 'o018' )
        set all = GetUnitCountDone( 'o019' )
        call AddAttackUnit( all, all, 'o019' )
        set all = GetUnitCountDone( 'h01I' )
        call AddAttackUnit( all, all, 'h01I' )
        set all = GetUnitCountDone( 'n01F' )
        call AddAttackUnit( all, all, 'n01F' )
        set all = GetUnitCountDone( 'o016' )
        call AddAttackUnit( all, all, 'o016' )
        set all = GetUnitCountDone( 'h020' )
        call AddAttackUnit( all, all, 'h020' )
        set all = GetUnitCountDone( 'h023' )
        call AddAttackUnit( all, all, 'h023' )
        set all = GetUnitCountDone( 'n01Q' )
        call AddAttackUnit( all, all, 'n01Q' )
        if (gCond_Blue_Moon_Risen) then
            set all = GetUnitCountDone( 'n01N' )
            call AddAttackUnit( all, all, 'n01N' )
        endif
        set all = GetUnitCountDone( 'n01R' )
        call AddAttackUnit( all, all, 'n01R' )

    endif
endfunction

//===========================================================================
// Prepares an attack group based on the current attack wave
//===========================================================================
function PrepareForces takes nothing returns nothing
    if (attackWave == 1) then
        call PrepareAttackGroup( 1 )
    endif
endfunction

//===========================================================================
// Sleep delays for each attack wave
//===========================================================================
function AttackWaveDelay takes integer inWave returns nothing
    if (inWave < nextDelay) then
        return
    endif

    set nextDelay = inWave + 1
endfunction

//===========================================================================
// Advances attack wave counter
//===========================================================================
function AttackWaveUpdate takes nothing returns nothing
    call AttackWaveDelay( attackWave )
    set attackWave = attackWave + 1
    if (attackWave > 1) then
        set attackWave = 1
        set nextDelay = attackWave + 1
    endif
endfunction

//===========================================================================
// Basic attack functionality
//===========================================================================
function AttackTarget takes unit target, boolean addAlliance returns nothing
    if (target == null) then
        return
    endif
    if (addAlliance) then
        call SetAllianceTarget( target )
    endif
    call FormGroup( 3, true )
    call AttackMoveKillA( target )
    if (not addAlliance) then
        call SetAllianceTarget( null )
    endif
endfunction

//===========================================================================
// Initiates an attack based on target priorities
//===========================================================================
function LaunchAttack takes nothing returns nothing
    local unit target = null
    local boolean setAlly = true

    // Don't launch any attack while town is threatened
    if (TownThreatened()) then
        call Sleep( 2 )
        return
    endif

    // Target Priority #1
    if (target == null) then
        set target = GetAllianceTarget()
        if (target != null) then
            set setAlly = false
        endif
    endif

    // Target Priority #2
    if (target == null) then
        set target = GetExpansionFoe()
        if (target != null) then
            set take_exp = false
        endif
    endif

    // Target Priority #3
    if (target == null) then
        set target = GetMegaTarget()
    endif

    // Target Priority #4
    if (target == null) then
        set target = GetEnemyExpansion()
    endif

    // Target Priority #5
    if (target == null) then
        set target = GetEnemyExpansion()
        if (target == null) then
            call StartGetEnemyBase(  )
            loop
                exitwhen (not WaitGetEnemyBase())
                call SuicideSleep( 1 )
            endloop
            set target = GetEnemyBase()
        endif
    endif

    // Target Priority #6
    if (target == null) then
        set target = GetCreepCamp( 0, 9, false )
    endif

    // Target Priority #7
    if (target == null) then
        set target = GetCreepCamp( 10, 100, true )
    endif

    // Attack the target and increment attack wave
    if (target != null) then
        call AttackTarget( target, setAlly )
        call AttackWaveUpdate(  )
    else
        // If no target was found, sleep a bit before trying again
        call Sleep( 20 )
    endif
endfunction

//===========================================================================
// Determines all attacking assignments
//===========================================================================
function AttackAssignment takes nothing returns nothing
    call StaggerSleep( 0, 2 )
    if (attackWave == 1) then
        call AttackWaveDelay( 0 )
    endif
    loop
        loop
            call UpdateConditions(  )
            exitwhen (HaveMinimumAttackers() and not CaptainRetreating())
            call Sleep( 2 )
        endloop
        call RemoveInjuries(  )
        call ResetAttackUnits(  )
        call PrepareForces(  )
        call LaunchAttack(  )
    endloop
endfunction

//***************************************************************************
//*
//*  Main Entry Point
//*
//***************************************************************************

//===========================================================================
function main takes nothing returns nothing
    call InitAI(  )
    call InitOptions(  )
    call SelectHeroes(  )
    call CreateCaptains(  )
    call SetHeroLevels( function ChooseHeroSkill )

    call Sleep( 0.1 )
    call StartThread( function WorkerAssignment )
    call StartThread( function AttackAssignment )
    call PlayGame(  )
endfunction

